from fastapi import FastAPI, UploadFile, File, Form, Request
from fastapi.responses import JSONResponse, FileResponse
from fastapi.middleware.cors import CORSMiddleware
import openai
import uuid
import os
import requests
import json
import tempfile
from openpyxl import load_workbook

# --- NASTAV SVÉ KLÍČE ---
OPENAI_API_KEY = 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
MAPYCZ_API_KEY = a-bpImyVMf55mk8c8ayWQde_xazVqCbPb8YXAFdnfB8
EXCEL_TEMPLATE_PATH = "./Template_Kniha_jizd_simulace.xlsx"

# -- Demo: seznam vozidel v paměti (můžeš načítat z DB nebo souboru)
CARS_JSON = [ ... ]  # [
  {
    "Firma": "OK BROKERS s.r.o.",
    "IČO": 25267001,
    "Vozidlo": "Škoda Superb",
    "RZ": "8M15169",
    "PHM": "Nafta",
    "Spotřeba l/100km": 6.23,
    "Řidič/odpovědná osoba": "Kubišová Jana"
  },
  {
    "Firma": "OK ECONOMY s.r.o.",
    "IČO": 44014929,
    "Vozidlo": "Škoda Superb",
    "RZ": "OKH00003",
    "PHM": "Benzín",
    "Spotřeba l/100km": 6.23,
    "Řidič/odpovědná osoba": "Šimková Petra"
  },
  {
    "Firma": "OK GROUP",
    "IČO": 28110056,
    "Vozidlo": "BMW 5",
    "RZ": "OKH00033",
    "PHM": "Benzín",
    "Spotřeba l/100km": 6.4,
    "Řidič/odpovědná osoba": "Ing. Michal Kubiš"
  },
  {
    "Firma": "Agroteam CZ s.r.o.",
    "IČO": 25561804,
    "Vozidlo": "Škoda Kodiaq",
    "RZ": "OKH30620",
    "PHM": "Benzín",
    "Spotřeba l/100km": 7.4,
    "Řidič/odpovědná osoba": "Kubišová Iva"
  },
  {
    "Firma": "OK Group a.s.",
    "IČO": 25561804,
    "Vozidlo": "BMW X5",
    "RZ": "7AA3030",
    "PHM": "Nafta",
    "Spotřeba l/100km": 9.9,
    "Řidič/odpovědná osoba": "Milan Ondra"
  },
  {
    "Firma": "OK GROUP s.r.o.",
    "IČO": 25561804,
    "Vozidlo": "ASTON MARTIN",
    "RZ": "OKH00007",
    "PHM": "Benzín",
    "Spotřeba l/100km": 10.2,
    "Řidič/odpovědná osoba": "Ing. Vladimíra Kubišová"
  },
  {
    "Firma": "OK Group a.s.,",
    "IČO": 25561804,
    "Vozidlo": "Škoda Superb",
    "RZ": "2BZ1888",
    "PHM": "Benzín",
    "Spotřeba l/100km": 6.23,
    "Řidič/odpovědná osoba": "Maloch Jan"
  },
  {
    "Firma": "OK Group a.s.",
    "IČO": 25561804,
    "Vozidlo": "Škoda Superb",
    "RZ": "2BZ1777",
    "PHM": "Benzín",
    "Spotřeba l/100km": 6.23,
    "Řidič/odpovědná osoba": "Malochová Renata"
  },
  {
    "Firma": "OK KLIENT a.s.",
    "IČO": 29185114,
    "Vozidlo": "BMW 5",
    "RZ": "OKH00088",
    "PHM": "Benzín",
    "Spotřeba l/100km": 6.4,
    "Řidič/odpovědná osoba": "Kubiš Radoslav ml."
  },
  {
    "Firma": "OK Group a.s.",
    "IČO": 25561804,
    "Vozidlo": "BMW 5",
    "RZ": "OKH00011",
    "PHM": "Natural",
    "Spotřeba l/100km": 6.4,
    "Řidič/odpovědná osoba": "Ing Kubiš Radoslav"
  },
  {
    "Firma": "Agroteam CZ s.r.o.",
    "IČO": 25561804,
    "Vozidlo": "LR Defender",
    "RZ": "OKH00001",
    "PHM": "Benzín",
    "Spotřeba l/100km": 11,
    "Řidič/odpovědná osoba": "Ing. Kubiš Radoslav"
  },
  {
    "Firma": "Agroteam CZ s.r.o.",
    "IČO": 25561804,
    "Vozidlo": "Range Rover",
    "RZ": "0KH11111",
    "PHM": "Benzín",
    "Spotřeba l/100km": 10.2,
    "Řidič/odpovědná osoba": "Ing. Kubiš Radoslav"
  },
  {
    "Firma": "OK GRANT s.r.o.",
    "IČO": 28268318,
    "Vozidlo": "BMW 8",
    "RZ": "0KH00002",
    "PHM": "Benzín",
    "Spotřeba l/100km": 7.4,
    "Řidič/odpovědná osoba": "Ing. Vladimíra Kubišová"
  }
]

app = FastAPI()
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

TMP_DIR = tempfile.gettempdir()

@app.get("/cars")
def get_cars():
    return CARS_JSON

@app.get("/address-suggest")
def address_suggest(query: str):
    url = f"https://api.mapy.cz/suggest?query={query}&lang=cs&apikey={MAPYCZ_API_KEY}"
    resp = requests.get(url)
    return resp.json()

@app.post("/route-distance")
def route_distance(data: dict):
    # Očekává { "from": "...", "to": "..." }
    # Dotaz na Mapy.cz Directions API
    url = f"https://api.mapy.cz/route?format=json&apikey={MAPYCZ_API_KEY}&from={data['from']}&to={data['to']}"
    resp = requests.get(url)
    return resp.json()  # Můžeš extrahovat pouze délku trasy, pokud chceš

@app.post("/simulate")
def simulate(request: Request):
    data = await request.json()
    car = data['car']
    events = data['events']

    # ZDE: (1) Získat reálné vzdálenosti pomocí Mapy.cz, (2) Připravit prompt pro GPT, (3) Zavolat GPT
    # Ukázkově: připrav prompt
    gpt_prompt = f"""
    Vehicle:
    {json.dumps(car, ensure_ascii=False)}

    Events:
    {json.dumps(events, ensure_ascii=False)}

    [Add here pre-calculated distances, e.g.:]
    Distances:
    Brno–Praha: 210 km
    Praha–Brno: 210 km
    ...

    Your instructions:
    {PROMPT_STRING}
    """

    # (3) Zavolat ChatGPT
    openai.api_key = OPENAI_API_KEY
    response = openai.ChatCompletion.create(
        model="gpt-4o",  # nebo gpt-3.5-turbo
        messages=[
            {"role": "system", "content": "You are an assistant for generating company vehicle logbooks."},
            {"role": "user", "content": gpt_prompt}
        ],
        max_tokens=2000,
        temperature=0.1
    )
    result = response.choices[0].message.content

    # (4) Zapsat výsledek do šablony Excelu
    file_id = str(uuid.uuid4())
    output_path = os.path.join(TMP_DIR, f"{file_id}.xlsx")
    wb = load_workbook(EXCEL_TEMPLATE_PATH)
    ws = wb.active
    # ZDE: DOPLŇ HLAVIČKU, DOPLŇ SIMULOVANÉ ŘÁDKY
    # Ukázka – každý řádek: ws.append([datum, tankování, trasa, km, účel])
    # Příklad: ws["B3"] = car["Vozidlo"] ... atd.

    wb.save(output_path)
    return {"success": True, "download_url": f"/download/{file_id}"}

@app.get("/download/{file_id}")
def download_excel(file_id: str):
    path = os.path.join(TMP_DIR, f"{file_id}.xlsx")
    return FileResponse(path, filename="Kniha_jizd.xlsx")
